<script>
 function showChilds(parent, num_children, is_auth, depth, username) {
     console.log("showChilds "+parent);
     if ($("#showreplies-"+parent).length) {
         $("#showreplies-"+parent).html("Piilota vastaukset ("+num_children+")");
         $("#showreplies-"+parent).attr("onclick", "hideChilds("+parent+", "+num_children+", "+is_auth+", "+depth+", \""+username+"\"); return false;");
     }
     $.getJSON("/getposts?parent="+parent, function(result){
         $.each(result, function(i, post) {
             posthtml = "<div class='post' id='post-"+post['id']+"'><p class='post-user'><a id='post-"+post['id']+"-userlink' href='{{ url_for('profile') }}?user="+encodeURIComponent(post['username'])+"'></a></p><p id='post-"+post['id']+"-message' class='post-message'></p><div class='replybar'>";
             if (is_auth) {
                 posthtml += "<a href='' onclick='showReplyField("+post['id']+");return false;'>Vastaa</a>";
             }
             if (username == post['username']) {
                posthtml += "<a href='' style='margin-left:15px;' onclick='showEditField("+post['id']+");return false;'>Muokkaa</a>";
                posthtml += "<a href='' style='margin-left:15px;' onclick='deletePost("+post['id']+");return false;'>Poista</a>";
             }
             if (post['children'] > 0) {
                 posthtml += "<a style='margin-left:15px;' id='showreplies-"+post['id']+"' href='' onclick='showChilds("+post['id']+", "+post['children']+", "+is_auth+", "+(depth+1)+", \""+username+"\");return false;'>N채yt채 vastaukset ("+post['children']+")";
             }
             posthtml += "</div><div id='post-"+post['id']+"-children' class='post-children'></div></div>";
             $("#post-"+parent+"-children").append(posthtml);
             $("#post-"+post['id']+"-message").text(post['message']);
             $("#post-"+post['id']+"-userlink").text(post['username']);
         });
         if (depth == 0) {
             $.each(result, function(i, post) {
                 showChilds(post['id'], post['children'], is_auth, depth+1, username);
             });
         }
     });
 }

 function deletePost(post_id) {
    $.post("{{ url_for('delete_post') }}", {id: post_id}, function(result){
        $("#post-"+post_id).remove();
    });
 }

 function hideChilds(parent, num_children, is_auth, depth, username) {
     console.log("hideChilds "+parent);
     $("#post-"+parent+"-children").empty();
     $("#showreplies-"+parent).html("N채yt채 vastaukset ("+num_children+")");
     $("#showreplies-"+parent).attr("onclick", "showChilds("+parent+", "+num_children+", "+is_auth+", "+depth+", \""+username+"\"); return false;");
 }

 function showReplyField(post) {
     $("#post-"+post+"-replyfield").remove();
     $("#post-"+post+"-editfield").remove();
     replyhtml = '<div class="replyfield" id="post-'+post+'-replyfield"><form method="POST" action=" {{ url_for('posts_create') }} "> {{ postform.message }} <input type="hidden" name="parent_msg" value="'+post+'"/><br><input type="submit" value="Vastaa"/></form></div>';
     $("#post-"+post+"-children").prepend(replyhtml);
 }

function showEditField(post) {
    $("#post-"+post+"-replyfield").remove();
     $("#post-"+post+"-editfield").remove();
     edithtml = '<div class="editfield" id="post-'+post+'-editfield"><form method="POST" action=" {{ url_for('edit_post') }} "> {{ postform.message }} <input type="hidden" name="id" value="'+post+'"/><br><input type="submit" value="Muokkaa"/></form></div>';
     $("#post-"+post+"-children").prepend(edithtml);
     $("#post-"+post+"-editfield form textarea").val($("#post-"+post+"-message").text());
}
</script>
